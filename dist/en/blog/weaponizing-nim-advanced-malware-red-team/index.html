<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="color-scheme" content="dark"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap"><link rel="icon" href="/favicon.svg"><link rel="canonical" href="https://maindavis.github.io/en/blog/weaponizing-nim-advanced-malware-red-team/"><title>Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers</title><meta name="title" content="Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers"><meta name="description" content="An advanced guide to using Nim for offensive development: syscalls, memory work, opsec, and stealth execution."><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://maindavis.github.io/en/blog/weaponizing-nim-advanced-malware-red-team/"><meta property="og:title" content="Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers"><meta property="og:description" content="An advanced guide to using Nim for offensive development: syscalls, memory work, opsec, and stealth execution."><meta property="og:image" content="https://maindavis.github.io/open-graph/en/weaponizing-nim-advanced-malware-red-team.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://maindavis.github.io/en/blog/weaponizing-nim-advanced-malware-red-team/"><meta property="twitter:title" content="Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers"><meta property="twitter:description" content="An advanced guide to using Nim for offensive development: syscalls, memory work, opsec, and stealth execution."><meta property="twitter:image" content="https://maindavis.github.io/open-graph/en/weaponizing-nim-advanced-malware-red-team.png"><link rel="stylesheet" href="/_astro/about.B9y4o1ar.css">
<link rel="stylesheet" href="/_astro/index.BcZbEljn.css"></head> <body class="min-h-screen"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var l=(o,t)=>{let i=async()=>{await(await o())()},e=typeof t.value=="object"?t.value:void 0,s={timeout:e==null?void 0:e.timeout};"requestIdleCallback"in window?window.requestIdleCallback(i,s):setTimeout(i,s.timeout||200)};(self.Astro||(self.Astro={})).idle=l;window.dispatchEvent(new Event("astro:idle"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z2c8VbI" prefix="r0" component-url="/_astro/MatrixRain.TxUs3SNa.js" component-export="default" renderer-url="/_astro/client.BuOr9PT5.js" props="{}" ssr="" client="idle" opts="{&quot;name&quot;:&quot;MatrixRain&quot;,&quot;value&quot;:true}" await-children=""><canvas class="pointer-events-none fixed inset-0 z-0 opacity-40" aria-hidden="true"></canvas><!--astro:end--></astro-island> <astro-island uid="Z1upAD6" prefix="r1" component-url="/_astro/SearchModal.BgunQDqN.js" component-export="default" renderer-url="/_astro/client.BuOr9PT5.js" props="{&quot;locale&quot;:[0,&quot;en&quot;]}" ssr="" client="idle" opts="{&quot;name&quot;:&quot;SearchModal&quot;,&quot;value&quot;:true}"></astro-island> <div class="relative z-10 flex min-h-screen flex-col"> <header class="border-b border-terminal-border bg-terminal-black/90"> <div class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-4 md:flex-row md:items-center md:justify-between md:px-8"> <div class="flex items-center gap-3 text-xs uppercase tracking-[0.3em] text-terminal-muted/80"> <span class="h-2 w-2 rounded-full bg-terminal-green shadow-glow"></span> SESSION_ACTIVE :: RED_TEAM_ENGAGEMENT </div> <div class="flex flex-wrap items-center gap-3"> <nav class="flex gap-2 text-sm"> <a href="/en" class="rounded-sm border px-3 py-1 transition border-terminal-border text-terminal-muted hover:border-terminal-green hover:shadow-glow-strong"> ~/home </a><a href="/en/blog" class="rounded-sm border px-3 py-1 transition border-terminal-green text-terminal-green text-glow"> ~/blog </a><a href="/en/arsenal" class="rounded-sm border px-3 py-1 transition border-terminal-border text-terminal-muted hover:border-terminal-green hover:shadow-glow-strong"> ~/arsenal </a><a href="/en/about" class="rounded-sm border px-3 py-1 transition border-terminal-border text-terminal-muted hover:border-terminal-green hover:shadow-glow-strong"> ~/about </a> </nav> <a href="/es/blog/weaponizing-nim-advanced-malware-red-team" class="rounded-sm border border-terminal-border px-3 py-1 text-xs uppercase tracking-[0.25em] text-terminal-muted transition hover:border-terminal-green hover:text-terminal-green"> ES </a> </div> </div> </header> <main class="flex-1 px-4 pb-12 pt-6 md:px-8">  <section class="mx-auto w-full max-w-5xl"> <div class="panel border-glow rounded-md px-5 py-4"> <h1 class="text-xl text-terminal-green text-glow">Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers</h1> <p class="mt-2 text-sm text-terminal-cyan/80">An advanced guide to using Nim for offensive development: syscalls, memory work, opsec, and stealth execution.</p> </div> <div class="mt-6">  <div class="post-hero border border-terminal-border/70 rounded-md"> <img src="/images/blog/offensive-nim.png" alt="Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers" loading="eager" decoding="async" fetchpriority="high"> </div> <article class="panel border-glow mt-6 rounded-md px-5 py-5 text-sm leading-relaxed text-terminal-light/90"> <h1 id="weaponizing-nim-advanced-malware-development-and-evasion-guide-for-red-teamers">Weaponizing Nim: Advanced Malware Development and Evasion Guide for Red Teamers</h1>
<p>If you have been doing pentesting or Red Teaming lately, you have probably noticed a shift in the tooling ecosystem. For years, C# and PowerShell were the kings, but signatures and logging (AMSI, Script Block Logging) have made it harder to operate without detection. This is where Nim comes in.</p>
<p>Recently, Nim has become the preferred option for many malware developers. Why? Because it has a Python-like friendly syntax, but it compiles to native Windows executables or DLLs very easily, without relying on a heavy virtual machine like Java or even Golang.</p>
<p>This article is not a basic introduction. We will go deeper into how to use Nim to interact directly with the Windows Native API (syscalls), how to handle memory offensively, and how to avoid the common mistakes people make when porting code from C to Nim.</p>
<hr>
<h2 id="setup-and-compilation-for-opsec">Setup and Compilation for OpSec</h2>
<p>First, forget Visual Studio. You do not need that heavy IDE. A simple editor like VS Code and the Nim compiler are enough. One of Nim’s biggest advantages is cross compilation. You can compile a Windows binary from Linux by installing the MinGW toolchain and passing a flag to the compiler.</p>
<h3 id="critical-compilation-flags">Critical Compilation Flags</h3>
<p>For offensive operations, you cannot use default settings. We need to reduce size and strip debug information that AV analysts can use to create signatures. Based on Nim documentation and field experience, this is the winning setup:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">nim</span><span style="color:#9ECBFF"> c</span><span style="color:#79B8FF"> -d:danger</span><span style="color:#79B8FF"> -d:strip</span><span style="color:#79B8FF"> --opt:size</span><span style="color:#9ECBFF"> payload.nim</span></span>
<span class="line"></span></code></pre>
<ul>
<li><code>-d:danger</code>: Removes all runtime checks (like array bounds). Risky, but needed for optimized malware.</li>
<li><code>-d:strip</code>: Strips symbols.</li>
<li><code>--opt:size</code>: Optimizes binary size.</li>
</ul>
<hr>
<h2 id="from-win32-to-syscalls-hook-evasion">From Win32 to Syscalls: Hook Evasion</h2>
<p>Most malware injects shellcode using a well known sequence of four methods:</p>
<ol>
<li><code>OpenProcess</code>: Get a handle.</li>
<li><code>VirtualAllocEx</code>: Reserve memory (RWX or RW).</li>
<li><code>WriteProcessMemory</code>: Write the payload.</li>
<li><code>CreateRemoteThread</code>: Execute.</li>
</ol>
<p>The problem is that EDRs and AVs place hooks in these functions at user level (in <code>ntdll.dll</code> or <code>kernel32.dll</code>) to inspect the flow and redirect it to their analysis engine.</p>
<p>To avoid this, we use syscalls. This lets us call the Native API directly, bypassing AV hooks. In Nim, that means mapping our calls to their native equivalents:</p>
<ul>
<li>Windows API -> Native API</li>
<li><code>OpenProcess</code> -> <code>NtOpenProcess</code></li>
<li><code>VirtualAllocEx</code> -> <code>NtAllocateVirtualMemory</code></li>
<li><code>WriteProcessMemory</code> -> <code>NtWriteVirtualMemory</code></li>
<li><code>CreateRemoteThread</code> -> <code>NtCreateThreadEx</code></li>
</ul>
<p>When implementing a runner with these syscalls, I have observed that solutions like Windows Defender often ignore the binary, especially if the payload is not embedded in the executable but downloaded over the network.</p>
<hr>
<h2 id="low-level-nim-pointers-memory-and-traps">Low-Level Nim: Pointers, Memory, and Traps</h2>
<p>This is where most people get stuck. Nim is a high-level language, but for malware we need to touch raw memory.</p>
<h3 id="shellcode-array-or-sequence">Shellcode: Array or Sequence?</h3>
<p>Use <code>seq[byte]</code> (sequence) instead of a fixed array. Sequences are dynamic, which lets you load payloads of variable size from a file or the network.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="nim"><code><span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> shellcode</span><span style="color:#F97583">:</span><span style="color:#F97583"> seq</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#F97583"> @</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">byte</span><span style="color:#79B8FF"> 0x41</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0x41</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0x41</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span></code></pre>
<h3 id="the-addr-vs-unsafeaddr-problem">The “addr” vs “unsafeAddr” problem</h3>
<p>This is the most critical point. In C, getting the address of an array is trivial. In Nim, you cannot simply use <code>addr</code> to get a direct pointer from a <code>seq[byte]</code>. You must use <code>unsafeAddr</code> and index the first element of the sequence.</p>
<p>If you try to pass the sequence directly to a Windows API like <code>VirtualAllocEx</code>, it will fail. The correct approach is:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="nim"><code><span class="line"><span style="color:#79B8FF">VirtualAllocEx</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">unsafeAddr </span><span style="color:#E1E4E8">shellcode[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">], </span><span style="color:#F97583">...</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span></code></pre>
<p>It is vital to index the variable (<code>shellcode[0]</code>) to get the pointer to the start of the data in memory.</p>
<h3 id="type-casting-and-structs">Type Casting and Structs</h3>
<p>Windows requires specific types (<code>HANDLE</code>, <code>DWORD</code>, etc.). In Nim, you can define these structs as objects. A key detail is using the <code>{.pure.}</code> pragma to ensure memory compatibility. Also, when passing initialized structs to functions (like <code>NtOpenProcess</code>), you may need to use <code>unsafeAddr</code> instead of <code>addr</code>, because <code>addr</code> may not behave as expected with objects managed by Nim.</p>
<p>Example of quick casting from an integer to <code>DWORD</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="nim"><code><span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> pid</span><span style="color:#F97583">:</span><span style="color:#F97583"> int</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1337</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> dPid</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> DWORD</span><span style="color:#F97583"> =</span><span style="color:#F97583"> cast</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">DWORD</span><span style="color:#E1E4E8">](pid)</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="real-weaponization-a-c2-runner-slivercobalt-strike">Real Weaponization: A C2 Runner (Sliver/Cobalt Strike)</h2>
<p>Let’s put this into practice. A modern runner should not carry the shellcode inside. It should download it.</p>
<p>I have experimented with a main module that receives parameters (HTTP or SMB), downloads the payload, removes the Initialization Vector (IV) if it comes from Sliver (the first 16 bytes), decrypts it (AES128 CBC), and injects it.</p>
<h3 id="decryption-and-cleanup-logic">Decryption and Cleanup Logic</h3>
<p>If you use Sliver, the payload often comes with a prepended IV. The Nim code must clean this before decryption:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="nim"><code><span class="line"><span style="color:#6A737D"># If this is Sliver, remove the IV from the first 16 bytes</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#F97583"> $</span><span style="color:#79B8FF">paramStr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> "sliver"</span><span style="color:#F97583">:</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> 16</span><span style="color:#F97583"> ..&#x3C;</span><span style="color:#E1E4E8"> shellcode</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">len</span><span style="color:#F97583">:</span></span>
<span class="line"><span style="color:#E1E4E8">    actual</span><span style="color:#F97583">.</span><span style="color:#79B8FF">add</span><span style="color:#E1E4E8">(shellcode[i])</span></span>
<span class="line"><span style="color:#E1E4E8">  shellcode </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> decrypt</span><span style="color:#E1E4E8">(actual, key, iv)</span></span>
<span class="line"></span></code></pre>
<h3 id="safer-injection">Safer Injection</h3>
<p>An OpSec tip: injecting into processes like <code>Notepad.exe</code> is a massive red flag for Defender. If you do that, your session will die quickly. It is better to let syscalls create their own process or thread, or inject into a process you spawned and suspended yourself, avoiding sensitive system process boundaries.</p>
<hr>
<h2 id="advanced-capabilities-the-offensivenim-repository">Advanced Capabilities: The “OffensiveNim” Repository</h2>
<p>If you want to go further, the OffensiveNim repository by Byt3bl33d3r is the must have reference. It contains snippets for almost every modern technique:</p>
<ul>
<li>Bypassing AMSI: Patching process memory to disable script scanning.</li>
<li>Bypassing ETW: Disabling Event Tracing for Windows to blind telemetry.</li>
<li>Unhooking ntdll: Reloading a clean copy of <code>ntdll</code> from disk to remove EDR hooks.</li>
<li>Shellcode Injection: Multiple methods, including classic injection and direct syscalls.</li>
<li>CLR Hosting: Executing .NET assemblies directly from memory without touching disk.</li>
</ul>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>Nim offers the elegance of a scripting language with the low-level power of C. It lets you build custom offensive tools quickly, manipulate memory precisely using pointers (be careful with <code>unsafeAddr</code>), and compile binaries that, for now, evade many security solutions simply because they are not C# or PowerShell.</p>
<p>If you are looking to upgrade your Red Team arsenal, porting your loaders and tools to Nim is the next logical step.</p> </article>  </div> </section>  </main> <footer class="border-t border-terminal-border bg-terminal-black/90"> <div class="mx-auto flex max-w-6xl flex-col gap-2 px-4 py-4 text-xs text-terminal-green/90 md:flex-row md:items-center md:justify-between md:px-8"> <span>Operator: MainDavis</span> <span> Status: active surveillance </span> </div> </footer> </div> </body></html>