---
import "../styles/globals.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import MatrixRain from "../components/MatrixRain.tsx";
import SearchModal from "../components/SearchModal.tsx";

const { title = "Secure Interface", description = "Cybersecurity & Red Teaming Blog", image = "/images/banner.jpeg", article = false } = Astro.props;
const supportedLocales = ["es", "en"];
const pathname = Astro.url.pathname;
const segments = pathname.split("/").filter(Boolean);
const locale = supportedLocales.includes(segments[0]) ? segments[0] : "es";

const metaTitle = title.length < 50 ? `${title} | MainDavis Red Team` : title;

// Ocultar Matrix solo al leer una entrada (blog/arsenal) o en proyectos; mantener en selectores
const blogIdx = segments.indexOf("blog");
const arsenalIdx = segments.indexOf("arsenal");
const isReadingBlog = blogIdx >= 0 && blogIdx < segments.length - 1;
const isReadingArsenal = arsenalIdx >= 0 && arsenalIdx < segments.length - 1;
const showMatrixBg =
  !isReadingBlog && !isReadingArsenal && !pathname.includes("/projects");

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
let socialImageURL = new URL(image, Astro.site);

if (article) {
  const slug = segments.slice(2).join("/");
  socialImageURL = new URL(`/open-graph/${locale}/${slug}.png`, Astro.site);
}
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap"
    />
    <link rel="icon" href="/favicon.svg" />
    <link rel="canonical" href={canonicalURL} />
    <title>{metaTitle}</title>
    <meta name="title" content={metaTitle} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? "article" : "website"} />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />
    {article && (
      <>
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
      </>
    )}

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={metaTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />
  </head>
  <body class="min-h-screen">
    {showMatrixBg && <MatrixRain client:idle />}
    <SearchModal client:idle locale={locale} />
    <div class="relative z-10 flex min-h-screen flex-col">
      <Header />
      <main class="flex-1 px-4 pb-12 pt-6 md:px-8">
        <slot />
      </main>
      <Footer />
    </div>
  </body>
</html>
